name: Release (Rust)

on:
  push:
    tags:
      - 'rs/v*'

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Extract Release Info
        id: extract_release_version
        run: |
          RELEASE_TAG=${GITHUB_REF#refs/tags/}
          RELEASE_VERSION=${RELEASE_TAG#rs/v}
          if [[ ! $RELEASE_VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "'$VERSION' is not a valid semver version"
            exit 1
          fi
          # Fetch commit details using the GitHub API
          COMMIT_DETAILS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/commits/$RELEASE_TAG")
          # Extract the author's name and email
          NAME=$(echo "$COMMIT_DETAILS" | jq -r .commit.author.name)
          EMAIL=$(echo "$COMMIT_DETAILS" | jq -r .commit.author.email)

          echo "Name: $NAME"
          echo "Email: $EMAIL"

          echo "release_version=$RELEASE_VERSION" >> $GITHUB_OUTPUT

      - name: Say Hi
        run: |
          echo "We are about to release: ${{ steps.extract_release_version.outputs.release_version }}"

      - name: Update Workspace Dependencies
        run: |
          cargo update

      - name: Set Workspace Version
        run: |
          sed -i "s/^version = \".*\"/version = \"${{ steps.extract_release_version.outputs.release_version }}\"/" Cargo.toml

      - name: Run Tests
        run: |
          cargo test

      - name: Commit Changes
        run: |
          git checkout -b releases/rs/v${{ steps.extract_release_version.outputs.release_version }}
          git add Cargo.toml
          git add Cargo.lock
          git commit -m "build: update version to v${{ steps.extract_release_version.outputs.release_version }}"
          git push origin releases/rs/v${{ steps.extract_release_version.outputs.release_version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
